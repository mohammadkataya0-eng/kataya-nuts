<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - Kataya Nuts</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#b51916] text-white font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex justify-center py-4 border-b border-white/20 shadow bg-[#b51916]">
    <img src="/images/logo.png" alt="Kataya Nuts Logo" class="w-20 sm:w-24" />
  </header>

  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 sm:px-6 py-10 text-center">
    <h1 class="text-3xl sm:text-4xl font-bold mb-4">\ud83d\udccb Your Order – \u0637\u0644\u0628\u0643</h1>
    <p class="text-white/90 text-base sm:text-lg mb-8 max-w-2xl mx-auto">
      Review your bags and send your order directly to WhatsApp.
    </p>

    <!-- Bag Summary -->
    <div id="bagList" class="bg-white text-gray-800 max-w-2xl mx-auto rounded-xl shadow-lg p-6 text-left mb-8">
      <!-- Bags will be injected here -->
    </div>

    <!-- Buttons -->
    <div class="flex flex-col sm:flex-row justify-center gap-4">
      <a href="/bag" class="bg-[#d89a63] hover:bg-[#c0804f] text-white px-6 py-3 rounded-full font-semibold transition">
        \ud83d\udd19 Return to Bags – \u0627\u0644\u0639\u0648\u062f\u0629 \u0625\u0644\u0649 \u0627\u0644\u0623\u0643\u064a\u0627\u0633
      </a>
      <a id="sendBtn" href="#" target="_blank"
         class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full text-lg font-semibold transition">
        \ud83d\udcf1 Send Order via WhatsApp – \u0625\u0631\u0633\u0627\u0644 \u0627\u0644\u0637\u0644\u0628 \u0639\u0628\u0631 \u0648\u0627\u062a\u0633\u0627\u0628
      </a>
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center py-4 text-white/70 text-sm">
    &copy; <%= new Date().getFullYear() %> Kataya Nuts. All rights reserved.
  </footer>

  <script>
    const bagCart = JSON.parse(localStorage.getItem("bagCart") || "[]");
    const bagList = document.getElementById("bagList");
    const sendBtn = document.getElementById("sendBtn");

    async function loadItems() {
      const res = await fetch('/api/items');
      const items = await res.json();
      const priceMap = {};
      items.forEach(i => {
        priceMap[i._id] = { name: i.name, price: i.pricePerKg };
      });

      if (bagCart.length === 0) {
        bagList.innerHTML = `<p class="text-center text-lg text-gray-600">\ud83d\udecd\ufe0f No bags found. Go fill one!</p>`;
        sendBtn.style.display = "none";
        return;
      }

      let message = `\u202aHello Kataya Nuts,\n\u0645\u0631\u062d\u0628\u0627 \u0643\u0627\u062a\u0627\u064a\u0627 \u0646\u0627\u062a\u0633\u060c\n\nI'd like to place the following order:\n\u0623\u0631\u063a\u0628 \u0641\u064a \u062a\u0642\u062f\u064a\u0645 \u0627\u0644\u0637\u0644\u0628 \u0627\u0644\u062a\u0627\u0644\u064a:\n`;
      let grandTotal = 0;

      bagCart.forEach((bag, index) => {
        const bagDiv = document.createElement("div");
        bagDiv.className = "mb-6 border-b border-gray-300 pb-4";
        bagDiv.dataset.bagIndex = index;

        const header = document.createElement("h3");
        header.className = "font-bold text-xl mb-2";
        header.textContent = `\ud83d\udc5c Bag ${index + 1} – \u0627\u0644\u0643\u064a\u0633 ${index + 1}`;
        bagDiv.appendChild(header);

        const ul = document.createElement("ul");
        ul.className = "list-disc list-inside space-y-1 text-sm";

        let totalWeight = 0;
        let totalPrice = 0;

        for (const [id, qty] of Object.entries(bag)) {
          const product = priceMap[id];
          if (!product) continue;

          const weight = parseFloat(qty);
          const linePrice = weight * product.price;

          totalWeight += weight;
          totalPrice += linePrice;

          const li = document.createElement("li");
          li.textContent = `${product.name}: ${weight.toFixed(2)} kg`;
          ul.appendChild(li);

          message += `- ${product.name}: ${weight.toFixed(2)} kg\n- \u0627\u0644\u0645\u0646\u062a\u062c: ${product.name}, \u0627\u0644\u0648\u0632\u0646: ${weight.toFixed(2)} \u0643\u0644\u063a\n`;
        }

        bagDiv.appendChild(ul);

        const summary = document.createElement("div");
        summary.className = "text-sm text-gray-700 mt-2 space-y-1";
        summary.innerHTML = `
          <p>\ud83c\udf7f Total Weight: ${totalWeight.toFixed(2)} kg</p>
          <p>\ud83d\udcb0 Estimated Price: $${totalPrice.toFixed(2)}</p>
        `;
        bagDiv.appendChild(summary);

        message += `\n\ud83c\udf7f Total Weight: ${totalWeight.toFixed(2)} kg\n\u0627\u0644\u0648\u0632\u0646 \u0627\u0644\u0625\u062c\u0645\u0627\u0644\u064a: ${totalWeight.toFixed(2)} \u0643\u0644\u063a\n`;
        message += `\ud83d\udcb0 Estimated Price: $${totalPrice.toFixed(2)}\n\u0627\u0644\u0633\u0639\u0631 \u0627\u0644\u062a\u0642\u062f\u064a\u0631\u064a: $${totalPrice.toFixed(2)}\n\n`;

        const noteLabel = document.createElement("label");
        noteLabel.className = "block mt-3 text-sm font-semibold text-gray-800";
        noteLabel.textContent = "\u270f\ufe0f Note for this bag:";
        const note = document.createElement("textarea");
        note.className = "mt-1 p-2 border w-full rounded text-sm text-gray-800";
        note.placeholder = "Add a note...";
        note.rows = 2;
        note.dataset.bagIndex = index;

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "mt-3 text-red-600 hover:underline text-sm";
        deleteBtn.textContent = "\ud83d\uddd1\ufe0f Delete this bag";
        deleteBtn.onclick = () => {
          bagCart.splice(index, 1);
          localStorage.setItem("bagCart", JSON.stringify(bagCart));
          location.reload();
        };

        bagDiv.appendChild(noteLabel);
        bagDiv.appendChild(note);
        bagDiv.appendChild(deleteBtn);

        bagList.appendChild(bagDiv);
        grandTotal += totalPrice;
      });

      message += `\ud83d\udccb Grand Total: $${grandTotal.toFixed(2)}\n\u0627\u0644\u0645\u062c\u0645\u0648\u0639 \u0627\u0644\u0643\u0644\u064a: $${grandTotal.toFixed(2)}\n`;

      sendBtn.onclick = () => {
        const notes = bagList.querySelectorAll("textarea");
        notes.forEach(note => {
          const value = note.value.trim();
          if (value) {
            const bagIndex = parseInt(note.dataset.bagIndex) + 1;
            message += `\n\u270f\ufe0f Note for Bag ${bagIndex}: ${value}\n\u0645\u0644\u0627\u062d\u0638\u0629 \u0644\u0644\u0643\u064a\u0633 ${bagIndex}: ${value}`;
          }
        });

        message += `\n\nThank you!\n\u0634\u0643\u0631\u0627 \u0644\u0643\u0645!`;

        const whatsappNumber = "96171570585";
        sendBtn.href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
        localStorage.removeItem("bagCart");

        setTimeout(() => {
          window.location.href = "/bag";
        }, 2000);
      };
    }

    loadItems();
  </script>

</body>
</html>

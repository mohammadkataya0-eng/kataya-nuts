<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - Kataya Nuts</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#b51916] text-white font-sans min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex justify-center py-4 border-b border-white/20 shadow bg-[#b51916]">
    <img src="/images/logo.png" alt="Kataya Nuts Logo" class="w-20 sm:w-24" />
  </header>

  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 sm:px-6 py-10 text-center">
    <h1 class="text-3xl sm:text-4xl font-bold mb-4">📋 Your Order – طلبك</h1>
    <p class="text-white/90 text-base sm:text-lg mb-8 max-w-2xl mx-auto">
      Review your bags and send your order directly to WhatsApp.
    </p>

    <!-- Bag Summary -->
    <div id="bagList" class="bg-white text-gray-800 max-w-2xl mx-auto rounded-xl shadow-lg p-6 text-left mb-8">
      <!-- Bags will be injected here -->
    </div>

    <!-- Buttons (Updated) -->
    <div class="flex flex-col sm:flex-row justify-center gap-4">
      <a href="/bag" class="bg-[#d89a63] hover:bg-[#c0804f] text-white px-6 py-3 rounded-full font-semibold transition">
        🔙 Return to Bags – العودة إلى الأكياس
      </a>
      <a id="sendBtn" href="#" target="_blank"
         class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full text-lg font-semibold transition">
        📱 Send Order via WhatsApp – إرسال الطلب عبر واتساب
      </a>
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center py-4 text-white/70 text-sm">
    &copy; <%= new Date().getFullYear() %> Kataya Nuts. All rights reserved.
  </footer>

  <script>
    const bagCart = JSON.parse(localStorage.getItem("bagCart") || "[]");
    const bagList = document.getElementById("bagList");
    const sendBtn = document.getElementById("sendBtn");

    async function loadItems() {
      const res = await fetch('/api/items');
      const items = await res.json();
      const priceMap = {};
      items.forEach(i => {
        priceMap[i._id] = { name: i.name, price: i.pricePerKg };
      });

      if (bagCart.length === 0) {
        bagList.innerHTML = `<p class="text-center text-lg text-gray-600">🛍️ No bags found. Go fill one!</p>`;
        sendBtn.style.display = "none";
        return;
      }

      let message = `Hello Kataya Nuts,%0A%0AI’d like to place the following order:%0A`;
      let grandTotal = 0;

      bagCart.forEach((bag, index) => {
        const bagDiv = document.createElement("div");
        bagDiv.className = "mb-6 border-b border-gray-300 pb-4";
        bagDiv.dataset.bagIndex = index;

        const header = document.createElement("h3");
        header.className = "font-bold text-xl mb-2";
        header.textContent = `👜 Bag ${index + 1}`;
        bagDiv.appendChild(header);

        const ul = document.createElement("ul");
        ul.className = "list-disc list-inside space-y-1 text-sm";

        let totalWeight = 0;
        let totalPrice = 0;

        for (const [id, qty] of Object.entries(bag)) {
          const product = priceMap[id];
          if (!product) continue;

          const weight = parseFloat(qty);
          const linePrice = weight * product.price;

          totalWeight += weight;
          totalPrice += linePrice;

          const li = document.createElement("li");
          li.textContent = `${product.name}: ${weight.toFixed(2)} kg`;
          ul.appendChild(li);

          message += `%0A- ${product.name}: ${weight.toFixed(2)} kg`;
        }

        bagDiv.appendChild(ul);

        const summary = document.createElement("div");
        summary.className = "text-sm text-gray-700 mt-2 space-y-1";
        summary.innerHTML = `
          <p>🏷 Total Weight: ${totalWeight.toFixed(2)} kg</p>
          <p>💰 Estimated Price: $${totalPrice.toFixed(2)}</p>
        `;
        bagDiv.appendChild(summary);
        message += `%0A🏷 Total Weight: ${totalWeight.toFixed(2)} kg`;
        message += `%0A💰 Estimated Price: $${totalPrice.toFixed(2)}%0A`;

        // Optional note
        const noteLabel = document.createElement("label");
        noteLabel.className = "block mt-3 text-sm font-semibold text-gray-800";
        noteLabel.textContent = "✏️ Note for this bag:";
        const note = document.createElement("textarea");
        note.className = "mt-1 p-2 border w-full rounded text-sm text-gray-800";
        note.placeholder = "Add a note...";
        note.rows = 2;
        note.dataset.bagIndex = index;

        // Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "mt-3 text-red-600 hover:underline text-sm";
        deleteBtn.textContent = "🗑️ Delete this bag";
        deleteBtn.onclick = () => {
          bagCart.splice(index, 1);
          localStorage.setItem("bagCart", JSON.stringify(bagCart));
          location.reload();
        };

        bagDiv.appendChild(noteLabel);
        bagDiv.appendChild(note);
        bagDiv.appendChild(deleteBtn);

        bagList.appendChild(bagDiv);
        grandTotal += totalPrice;
      });

      message += `%0A🧾 Grand Total: $${grandTotal.toFixed(2)}%0A`;

      sendBtn.onclick = () => {
        const notes = bagList.querySelectorAll("textarea");
        notes.forEach(note => {
          const value = note.value.trim();
          if (value) {
            const bagIndex = parseInt(note.dataset.bagIndex) + 1;
            message += `%0A✏️ Note for Bag ${bagIndex}: ${encodeURIComponent(value)}`;
          }
        });

        message += `%0A%0AThank you!`;

        const whatsappNumber = "96171570585";
        sendBtn.href = `https://wa.me/${whatsappNumber}?text=${message}`;
        localStorage.removeItem("bagCart");

        setTimeout(() => {
          window.location.href = "/bag";
        }, 2000);
      };
    }

    loadItems();
  </script>

</body>
</html>
